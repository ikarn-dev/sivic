/**
 * Exploit Patterns Library
 * 
 * Maps DeFiLlama exploit techniques to detection rules and provides
 * pattern signatures for known attacks.
 */

import { SecurityRule, SOLANA_SECURITY_RULES } from './security-rules';

// Exploit technique to rule mapping
export interface ExploitTechniqueMapping {
    technique: string;
    ruleIds: string[];
    description: string;
    chainRelevance: string[];
    averageLoss: number;
    occurrences: number;
}

// Known exploit techniques from DeFiLlama
export const EXPLOIT_TECHNIQUE_MAPPINGS: ExploitTechniqueMapping[] = [
    // Reentrancy-based
    {
        technique: 'Reentrancy',
        ruleIds: ['SOL-REENT-001', 'SOL-REENT-002'],
        description: 'Classic reentrancy attack where external calls allow re-entry before state update',
        chainRelevance: ['Solana', 'Ethereum', 'BSC'],
        averageLoss: 5000000,
        occurrences: 15,
    },
    {
        technique: 'Flashloan Reentrancy Attack',
        ruleIds: ['SOL-REENT-001', 'SOL-FLASH-001'],
        description: 'Reentrancy attack amplified with flashloan capital',
        chainRelevance: ['Ethereum', 'BSC', 'Polygon', 'Fantom'],
        averageLoss: 12000000,
        occurrences: 12,
    },

    // Oracle/Price Manipulation
    {
        technique: 'Flashloan Price Oracle Attack',
        ruleIds: ['SOL-ORACLE-001', 'SOL-FLASH-001'],
        description: 'Flashloan used to manipulate oracle prices within single transaction',
        chainRelevance: ['Solana', 'Ethereum', 'BSC', 'Fantom'],
        averageLoss: 18000000,
        occurrences: 25,
    },
    {
        technique: 'Price Oracle Attack',
        ruleIds: ['SOL-ORACLE-001', 'SOL-ORACLE-002'],
        description: 'Oracle price manipulation without flashloan',
        chainRelevance: ['Solana', 'Ethereum', 'Arbitrum'],
        averageLoss: 8000000,
        occurrences: 10,
    },
    {
        technique: 'Price Oracle Manipulation',
        ruleIds: ['SOL-ORACLE-001', 'SOL-ORACLE-003'],
        description: 'General oracle price manipulation',
        chainRelevance: ['Solana', 'Ethereum'],
        averageLoss: 6000000,
        occurrences: 8,
    },
    {
        technique: 'Oracle Manipulation',
        ruleIds: ['SOL-ORACLE-001', 'SOL-ORACLE-002'],
        description: 'Direct oracle manipulation attack',
        chainRelevance: ['Ethereum', 'BSC'],
        averageLoss: 4000000,
        occurrences: 5,
    },
    {
        technique: 'Outdated Oracle Exploit',
        ruleIds: ['SOL-ORACLE-002'],
        description: 'Exploiting stale oracle prices',
        chainRelevance: ['Terra', 'Avalanche', 'Arbitrum'],
        averageLoss: 8000000,
        occurrences: 4,
    },
    {
        technique: 'Oracle Misconfiguration Exploit',
        ruleIds: ['SOL-ORACLE-002', 'SOL-ORACLE-003'],
        description: 'Exploiting incorrectly configured oracle parameters',
        chainRelevance: ['Ethereum'],
        averageLoss: 250000,
        occurrences: 2,
    },

    // Access Control
    {
        technique: 'Access Control Exploit',
        ruleIds: ['SOL-ACCESS-001', 'SOL-ACCESS-002'],
        description: 'Bypassing or exploiting missing access controls',
        chainRelevance: ['Solana', 'Ethereum', 'BSC'],
        averageLoss: 15000000,
        occurrences: 12,
    },
    {
        technique: 'Private Key Compromised',
        ruleIds: ['SOL-ACCESS-003'],
        description: 'Admin private key stolen or compromised',
        chainRelevance: ['All chains'],
        averageLoss: 50000000,
        occurrences: 45,
    },
    {
        technique: 'Private Key Compromised (Unknown Method)',
        ruleIds: ['SOL-ACCESS-003'],
        description: 'Private key compromise through unknown vector',
        chainRelevance: ['All chains'],
        averageLoss: 75000000,
        occurrences: 30,
    },
    {
        technique: 'Deployer Wallet Compromised',
        ruleIds: ['SOL-ACCESS-001', 'SOL-ACCESS-003'],
        description: 'Deployer/owner wallet compromised',
        chainRelevance: ['Ethereum'],
        averageLoss: 1200000,
        occurrences: 2,
    },
    {
        technique: 'Ownership Override Attack',
        ruleIds: ['SOL-ACCESS-001', 'SOL-ACCESS-002'],
        description: 'Overwriting contract ownership through vulnerability',
        chainRelevance: ['Ethereum'],
        averageLoss: 1000000,
        occurrences: 3,
    },

    // Token Minting
    {
        technique: 'Infinite Mint and Dump',
        ruleIds: ['SOL-MINT-001', 'SOL-MINT-002'],
        description: 'Exploiting mint function to create unlimited tokens',
        chainRelevance: ['Ethereum', 'BSC', 'Solana'],
        averageLoss: 8000000,
        occurrences: 12,
    },
    {
        technique: 'Burn Function Mistake',
        ruleIds: ['SOL-MINT-003', 'SOL-MATH-001'],
        description: 'Bug in burn function allowing exploitation',
        chainRelevance: ['Ethereum', 'Arbitrum', 'BSC'],
        averageLoss: 6500000,
        occurrences: 2,
    },

    // Flashloan Specific
    {
        technique: 'Flashloan Donate Function Logic Exploit',
        ruleIds: ['SOL-FLASH-002', 'SOL-MATH-001'],
        description: 'Donate function exploited via flashloan to manipulate pool state',
        chainRelevance: ['Ethereum', 'Optimism'],
        averageLoss: 40000000,
        occurrences: 5,
    },
    {
        technique: 'Flashloan Governance Attack',
        ruleIds: ['SOL-GOV-001', 'SOL-FLASH-001'],
        description: 'Using flashloaned tokens for governance voting',
        chainRelevance: ['Ethereum'],
        averageLoss: 90000000,
        occurrences: 2,
    },
    {
        technique: 'Flashloan Pool Shares Exploit',
        ruleIds: ['SOL-FLASH-001', 'SOL-LIQ-001'],
        description: 'Manipulating pool share calculations with flashloan',
        chainRelevance: ['Ethereum', 'BSC'],
        averageLoss: 20000000,
        occurrences: 4,
    },
    {
        technique: 'Flashloan Incentive Rewards Exploit',
        ruleIds: ['SOL-FLASH-001', 'SOL-MATH-001'],
        description: 'Gaming reward calculations with flashloaned liquidity',
        chainRelevance: ['BSC', 'Ethereum'],
        averageLoss: 5000000,
        occurrences: 8,
    },
    {
        technique: 'Flashloan Swap Logic Exploit',
        ruleIds: ['SOL-FLASH-001', 'SOL-MATH-001'],
        description: 'Exploiting swap logic flaws with flashloan capital',
        chainRelevance: ['Ethereum'],
        averageLoss: 25000000,
        occurrences: 3,
    },
    {
        technique: 'Flashloan Exploit',
        ruleIds: ['SOL-FLASH-001'],
        description: 'General flashloan-based attack',
        chainRelevance: ['All EVM chains'],
        averageLoss: 3000000,
        occurrences: 5,
    },

    // Math/Logic Errors
    {
        technique: 'Math Mistake Exploit',
        ruleIds: ['SOL-MATH-001', 'SOL-MATH-002'],
        description: 'Arithmetic errors in contract calculations',
        chainRelevance: ['Ethereum', 'BSC'],
        averageLoss: 60000000,
        occurrences: 3,
    },
    {
        technique: 'Rounding Donation Attack',
        ruleIds: ['SOL-MATH-003', 'SOL-FLASH-002'],
        description: 'Exploiting rounding errors through donations',
        chainRelevance: ['Ethereum'],
        averageLoss: 500000,
        occurrences: 2,
    },
    {
        technique: 'Decimal Miscalculation Exploit',
        ruleIds: ['SOL-MATH-001', 'SOL-MATH-003'],
        description: 'Token decimal handling errors',
        chainRelevance: ['BSC'],
        averageLoss: 2000000,
        occurrences: 1,
    },

    // Delegation/External Calls
    {
        technique: 'Delegatecall Exploit',
        ruleIds: ['SOL-CPI-001'],
        description: 'Malicious use of delegatecall for code injection',
        chainRelevance: ['Ethereum', 'Arbitrum'],
        averageLoss: 10000000,
        occurrences: 4,
    },
    {
        technique: 'External Call Vulnerability',
        ruleIds: ['SOL-CPI-001', 'SOL-CPI-002'],
        description: 'Unsafe external call patterns',
        chainRelevance: ['Ethereum'],
        averageLoss: 2000000,
        occurrences: 2,
    },
    {
        technique: 'Arbitrary External Call',
        ruleIds: ['SOL-CPI-002'],
        description: 'User-controlled external call targets',
        chainRelevance: ['Ethereum', 'Arbitrum'],
        averageLoss: 1200000,
        occurrences: 3,
    },
    {
        technique: 'Router Exploit',
        ruleIds: ['SOL-CPI-002', 'SOL-VAL-003'],
        description: 'Exploiting aggregator/router logic',
        chainRelevance: ['Ethereum', 'Multiple'],
        averageLoss: 5000000,
        occurrences: 6,
    },

    // Liquidity/Pool Attacks
    {
        technique: 'Drained Liquidity Pool',
        ruleIds: ['SOL-LIQ-001'],
        description: 'LP tokens used to drain liquidity (rugpull)',
        chainRelevance: ['BSC', 'Base', 'Ethereum'],
        averageLoss: 10000000,
        occurrences: 10,
    },
    {
        technique: 'Liquidity Pool Exploit',
        ruleIds: ['SOL-LIQ-001', 'SOL-LIQ-002'],
        description: 'Exploiting pool mechanics for profit',
        chainRelevance: ['BSC'],
        averageLoss: 200000,
        occurrences: 2,
    },
    {
        technique: 'Liquidity Manipulation Exploit',
        ruleIds: ['SOL-LIQ-001', 'SOL-FLASH-001'],
        description: 'Manipulating liquidity for price impact',
        chainRelevance: ['ICP', 'Ethereum'],
        averageLoss: 7000000,
        occurrences: 2,
    },

    // Governance
    {
        technique: 'Voting Power Inflation',
        ruleIds: ['SOL-GOV-001', 'SOL-GOV-002'],
        description: 'Artificially inflating governance voting power',
        chainRelevance: ['Ethereum'],
        averageLoss: 16000000,
        occurrences: 1,
    },
    {
        technique: 'Multisig Governance Hack',
        ruleIds: ['SOL-ACCESS-003', 'SOL-GOV-001'],
        description: 'Compromising multisig governance',
        chainRelevance: ['Story'],
        averageLoss: 3900000,
        occurrences: 1,
    },

    // Signature/Validation
    {
        technique: 'Signature Exploit',
        ruleIds: ['SOL-VAL-002'],
        description: 'Exploiting signature verification flaws',
        chainRelevance: ['Solana', 'Ethereum'],
        averageLoss: 100000000,
        occurrences: 3,
    },
    {
        technique: 'Collateral Validation Exploit',
        ruleIds: ['SOL-VAL-003', 'SOL-ACCESS-002'],
        description: 'Bypassing collateral validation checks',
        chainRelevance: ['Solana'],
        averageLoss: 48000000,
        occurrences: 1,
    },
    {
        technique: 'Missing Input Validation',
        ruleIds: ['SOL-VAL-003'],
        description: 'Exploiting unvalidated user inputs',
        chainRelevance: ['Ethereum'],
        averageLoss: 2000000,
        occurrences: 3,
    },
    {
        technique: 'Token approval exploit',
        ruleIds: ['SOL-VAL-003', 'SOL-ACCESS-001'],
        description: 'Exploiting token approvals for theft',
        chainRelevance: ['Ethereum'],
        averageLoss: 3500000,
        occurrences: 3,
    },
    {
        technique: 'Replay Attack',
        ruleIds: ['SOL-VAL-002'],
        description: 'Replaying signed transactions/messages',
        chainRelevance: ['Ethereum'],
        averageLoss: 70000,
        occurrences: 1,
    },
];

// Solana-specific exploits from DeFiLlama data
export const SOLANA_EXPLOITS = [
    { name: 'MangoFarmSol', date: '2024-01', amount: 2000000, technique: 'Frontend Attack' },
    { name: 'M2 Exchange', date: '2024-10', amount: 13700000, technique: 'Access Control Exploit' },
    { name: 'pump.fun', date: '2024-05', amount: 2000000, technique: 'Private Key Compromised' },
    { name: 'Mango Markets V3', date: '2022-10', amount: 115000000, technique: 'Price Oracle Attack' },
    { name: 'Portal (Wormhole)', date: '2022-02', amount: 326000000, technique: 'Signature Exploit' },
    { name: 'Solareum', date: '2024-03', amount: 1400000, technique: 'Private Key Compromised' },
    { name: 'Loopscale', date: '2025-04', amount: 5800000, technique: 'Price Oracle Manipulation' },
    { name: 'Cashio', date: '2022-03', amount: 48000000, technique: 'Collateral Validation Exploit' },
    { name: 'Crema Finance', date: '2022-07', amount: 8800000, technique: 'Access Control Exploit' },
    { name: 'Raydium AMM', date: '2022-12', amount: 4400000, technique: 'Private Key Compromised' },
    { name: 'Slope Wallet', date: '2022-08', amount: 5300000, technique: 'Private Key Compromised' },
    { name: 'Nirvana V1', date: '2022-07', amount: 3500000, technique: 'Flashloan Price Oracle Attack' },
    { name: 'Save (Solend)', date: '2022-11', amount: 1260000, technique: 'Price Oracle Attack' },
    { name: 'DEXX', date: '2024-11', amount: 21000000, technique: 'Private Key Compromised' },
    { name: 'Upbit', date: '2025-01', amount: 36000000, technique: 'Private Key Compromised' },
    { name: 'Step Finance', date: '2025-07', amount: 40000000, technique: 'Private Key Compromised' },
    { name: 'Garden', date: '2025-06', amount: 10800000, technique: 'Private Key Compromised' },
];

// Get related rules for a technique
export function getRulesForTechnique(technique: string): SecurityRule[] {
    const mapping = EXPLOIT_TECHNIQUE_MAPPINGS.find(
        m => m.technique.toLowerCase() === technique.toLowerCase()
    );

    if (!mapping) return [];

    return SOLANA_SECURITY_RULES.filter(rule => mapping.ruleIds.includes(rule.id));
}

// Get techniques by rule
export function getTechniquesForRule(ruleId: string): ExploitTechniqueMapping[] {
    return EXPLOIT_TECHNIQUE_MAPPINGS.filter(m => m.ruleIds.includes(ruleId));
}

// Get all techniques relevant to Solana
export function getSolanaTechniques(): ExploitTechniqueMapping[] {
    return EXPLOIT_TECHNIQUE_MAPPINGS.filter(
        m => m.chainRelevance.includes('Solana') || m.chainRelevance.includes('All chains')
    );
}

// Calculate technique risk score
export function getTechniqueRiskScore(technique: string): number {
    const mapping = EXPLOIT_TECHNIQUE_MAPPINGS.find(
        m => m.technique.toLowerCase() === technique.toLowerCase()
    );

    if (!mapping) return 0;

    // Score based on occurrences and average loss
    const occurrenceScore = Math.min(mapping.occurrences * 2, 30);
    const lossScore = Math.min(Math.log10(mapping.averageLoss) * 5, 40);
    const ruleCount = mapping.ruleIds.length * 10;

    return Math.min(occurrenceScore + lossScore + ruleCount, 100);
}

// Search exploits by keyword
export function searchExploits(query: string): ExploitTechniqueMapping[] {
    const lowerQuery = query.toLowerCase();
    return EXPLOIT_TECHNIQUE_MAPPINGS.filter(
        m => m.technique.toLowerCase().includes(lowerQuery) ||
            m.description.toLowerCase().includes(lowerQuery)
    );
}

// Get highest risk techniques
export function getHighestRiskTechniques(limit: number = 10): ExploitTechniqueMapping[] {
    return [...EXPLOIT_TECHNIQUE_MAPPINGS]
        .sort((a, b) => (b.averageLoss * b.occurrences) - (a.averageLoss * a.occurrences))
        .slice(0, limit);
}

// Total stats
export function getExploitStats() {
    const totalLoss = EXPLOIT_TECHNIQUE_MAPPINGS.reduce(
        (sum, m) => sum + (m.averageLoss * m.occurrences), 0
    );
    const totalOccurrences = EXPLOIT_TECHNIQUE_MAPPINGS.reduce(
        (sum, m) => sum + m.occurrences, 0
    );
    const uniqueTechniques = EXPLOIT_TECHNIQUE_MAPPINGS.length;

    return {
        totalLoss,
        totalOccurrences,
        uniqueTechniques,
        solanaExploits: SOLANA_EXPLOITS.length,
        solanaTotalLoss: SOLANA_EXPLOITS.reduce((sum, e) => sum + e.amount, 0),
    };
}

export default EXPLOIT_TECHNIQUE_MAPPINGS;
