'use client';

import { useState, useRef, useCallback, useEffect } from 'react';
import DashboardLayout from '@/components/DashboardLayout';
import { GlassContainerCard } from '@/components/Card';
import { PageHeader } from '@/components/PageHeader';
import { FormInput, FormTextarea, PrimaryButton, SecondaryButton } from '@/components/FormElements';
import { EmptyState, ShieldEmptyIcon } from '@/components/EmptyState';
import {
    MarketOverviewCard,
    ProfileSummaryCard,
    MiscCard,
    RiskScoreCard,
    TradingDataCard,
    RiskIndicatorsList,
    TopHoldersTable,
    AnalysisStep,
    AnalysisData,
    AIAnalysisCard,
    SecurityDataCard,
    SlippageDataCard,
    ParamsOverviewCard,
} from '@/components/AnalysisTimeline';
import { TimelineOverlay } from '@/components/TimelineOverlay';
import { toast } from 'sonner';

// ============================================
// SAMPLE CONTRACTS
// ============================================

const sampleContracts = [
    { label: 'Jupiter', value: 'JUP4Fb2cqiRUcaTHdrPC8h2gNsA2ETXiPDD33WcGuJB' },
    { label: 'Raydium', value: '675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8' },
    { label: 'Marinade', value: 'MarBmsSgKXdrN1egZf5sqe1TMai9K1rChYNDJgjq7aD' },
    { label: 'Pump.fun Token', value: '9SpP3JGB2PSryeXEE4evV2oMAXcy8R5Ay1JteBzZpump' },
];

// ============================================
// PAGE COMPONENT
// ============================================

export default function ExploitDetectorPage() {
    const [contractAddress, setContractAddress] = useState('');
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [steps, setSteps] = useState<AnalysisStep[]>([]);
    const [analysisData, setAnalysisData] = useState<AnalysisData | null>(null);
    const [totalDuration, setTotalDuration] = useState(0);
    const [activeTab, setActiveTab] = useState<'overview' | 'risks' | 'holders'>('overview');
    const [showTimeline, setShowTimeline] = useState(false);
    const [paramsChecked, setParamsChecked] = useState(0);
    const [paramsTriggered, setParamsTriggered] = useState(0);
    const [detectionMode, setDetectionMode] = useState<'token' | 'dex' | undefined>(undefined);
    const [imageError, setImageError] = useState(false);
    const startTimeRef = useRef<number>(0);
    const timerRef = useRef<NodeJS.Timeout | null>(null);

    // Update duration timer while analyzing
    useEffect(() => {
        if (isAnalyzing) {
            startTimeRef.current = Date.now();
            timerRef.current = setInterval(() => {
                setTotalDuration(Date.now() - startTimeRef.current);
            }, 100);
        } else if (timerRef.current) {
            clearInterval(timerRef.current);
        }

        return () => {
            if (timerRef.current) {
                clearInterval(timerRef.current);
            }
        };
    }, [isAnalyzing]);

    const eventSourceRef = useRef<EventSource | null>(null);

    const handleAnalyze = async () => {
        if (!contractAddress.trim()) {
            toast.error('Please enter a contract address');
            return;
        }

        // Reset state
        setIsAnalyzing(true);
        setSteps([]);
        setAnalysisData(null);
        setTotalDuration(0);
        setParamsChecked(0);
        setParamsTriggered(0);
        setDetectionMode(undefined);
        setImageError(false); // Reset image error state
        setShowTimeline(true); // Show timeline overlay during analysis

        try {
            const eventSource = new EventSource(`/api/contract/analyze-stream?address=${encodeURIComponent(contractAddress.trim())}`);
            eventSourceRef.current = eventSource;

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                switch (data.type) {
                    case 'step_start':
                        setSteps(prev => [...prev, {
                            id: data.stepId,
                            name: data.stepName,
                            status: 'running',
                        }]);
                        break;

                    case 'step_complete':
                        setSteps(prev => prev.map(step =>
                            step.id === data.stepId
                                ? { ...step, status: 'complete', duration: data.duration, data: data.data }
                                : step
                        ));
                        // Extract detection mode from step data
                        if (data.detectionMode) {
                            setDetectionMode(data.detectionMode);
                        }
                        // Extract param counts if present
                        if (data.paramsChecked !== undefined) {
                            setParamsChecked(data.paramsChecked);
                        }
                        if (data.paramsTriggered !== undefined) {
                            setParamsTriggered(data.paramsTriggered);
                        }
                        break;

                    case 'step_error':
                        setSteps(prev => prev.map(step =>
                            step.id === data.stepId
                                ? { ...step, status: 'error', duration: data.duration, error: data.error }
                                : step
                        ));
                        break;

                    case 'step_update':
                        // Update param tracking from stream events
                        if (data.paramsChecked !== undefined) {
                            setParamsChecked(data.paramsChecked);
                        }
                        if (data.paramsTriggered !== undefined) {
                            setParamsTriggered(data.paramsTriggered);
                        }
                        if (data.detectionMode) {
                            setDetectionMode(data.detectionMode);
                        }
                        break;

                    case 'data_update':
                        setAnalysisData(data.data);
                        break;

                    case 'complete':
                        setAnalysisData(data.data);
                        // Do NOT stop analyzing yet - wait for AI
                        // setIsAnalyzing(false); 
                        eventSource.close();
                        eventSourceRef.current = null;

                        // Extract final param counts
                        if (data.paramsChecked !== undefined) {
                            setParamsChecked(data.paramsChecked);
                        }
                        if (data.paramsTriggered !== undefined) {
                            setParamsTriggered(data.paramsTriggered);
                        }
                        if (data.detectionMode) {
                            setDetectionMode(data.detectionMode);
                        }

                        // Trigger AI Analysis via Gemini
                        let aiStarted = false;
                        if (data.data && !data.data.error) {
                            const aiStepId = 'ai_analysis';
                            setSteps(prev => [...prev, {
                                id: aiStepId,
                                name: 'Generating AI Analysis (OpenRouter)',
                                status: 'running'
                            }]);
                            aiStarted = true;

                            const aiStart = Date.now();
                            fetch('/api/ai/analyze', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ detectionData: data.data })
                            })
                                .then(res => res.json())
                                .then(aiResult => {
                                    if (aiResult && !aiResult.error) {
                                        setAnalysisData(prev => prev ? ({ ...prev, aiAnalysis: aiResult }) : null);
                                        setSteps(prev => prev.map(s => s.id === aiStepId ? {
                                            ...s,
                                            status: 'complete',
                                            duration: Date.now() - aiStart,
                                            data: aiResult
                                        } : s));
                                        toast.success('AI Analysis Complete', {
                                            description: 'Powered by OpenRouter'
                                        });
                                    } else {
                                        console.error('[AI Analysis] Failed:', aiResult?.message || aiResult?.error);
                                        setSteps(prev => prev.map(s => s.id === aiStepId ? {
                                            ...s,
                                            status: 'error',
                                            duration: Date.now() - aiStart,
                                            error: aiResult?.message || 'AI Generation Failed'
                                        } : s));
                                        toast.error('AI Analysis Failed', {
                                            description: aiResult?.message || 'Unable to generate AI analysis'
                                        });
                                    }
                                })
                                .catch(err => {
                                    console.error('[AI Analysis] Error:', err);
                                    setSteps(prev => prev.map(s => s.id === aiStepId ? {
                                        ...s,
                                        status: 'error',
                                        duration: Date.now() - aiStart,
                                        error: 'AI request failed'
                                    } : s));
                                })
                                .finally(() => {
                                    // Stop analyzing ONLY after AI is done
                                    setIsAnalyzing(false);
                                });
                        }

                        if (!aiStarted) {
                            setIsAnalyzing(false);
                        }

                        if (data.data.error) {
                            toast.error('Analysis failed', { description: data.data.error });
                        } else {
                            const grade = data.data.riskScore?.grade || 'N/A';
                            if (grade === 'F' || grade === 'D') {
                                toast.error(`Risk Grade: ${grade}`, {
                                    description: 'High risk detected - review findings carefully',
                                });
                            } else if (grade === 'C') {
                                toast.warning(`Risk Grade: ${grade}`, {
                                    description: 'Moderate risk detected',
                                });
                            } else {
                                toast.success(`Risk Grade: ${grade}`, {
                                    description: 'Analysis complete',
                                });
                            }
                        }
                        break;
                }
            };

            eventSource.onerror = (err) => {
                setIsAnalyzing(false);
                eventSource.close();
                eventSourceRef.current = null;
                toast.error('Connection error', { description: 'Failed to connect to analysis stream' });
            };

        } catch (error) {
            setIsAnalyzing(false);
            toast.error('Analysis failed', {
                description: error instanceof Error ? error.message : 'Unknown error'
            });
        }
    };

    // Cleanup EventSource on unmount
    useEffect(() => {
        return () => {
            if (eventSourceRef.current) {
                eventSourceRef.current.close();
                eventSourceRef.current = null;
            }
        };
    }, []);

    const handleClear = () => {
        setContractAddress('');
        setSteps([]);
        setAnalysisData(null);
        setTotalDuration(0);
        setActiveTab('overview');
        setParamsChecked(0);
        setParamsTriggered(0);
        setDetectionMode(undefined);
    };

    const handleExport = useCallback(() => {
        if (!analysisData) return;

        const dataStr = JSON.stringify(analysisData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `analysis-${analysisData.address.slice(0, 8)}-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        toast.success('Report exported');
    }, [analysisData]);

    // Dynamic tabs based on detection mode - DEX mode hides Holders tab
    const tabs = detectionMode === 'dex'
        ? [
            { id: 'overview', label: 'Overview' },
            { id: 'risks', label: 'Risk Indicators' },
        ]
        : [
            { id: 'overview', label: 'Overview' },
            { id: 'risks', label: 'Risk Indicators' },
            { id: 'holders', label: 'Holders' },
        ];

    return (
        <DashboardLayout>
            <div className="space-y-6">
                {/* Header */}
                <PageHeader
                    title="Exploit Detector"
                    description="Real-time on-chain security analysis for Solana contracts"
                />

                {/* Input Section - Centered with top margin */}
                <GlassContainerCard className="p-4 sm:p-6 max-w-3xl mx-auto mt-4">
                    <div className="space-y-4">
                        {/* Input Row - Always horizontal, bottom aligned */}
                        <div className="flex items-end gap-2 sm:gap-3">
                            <div className="flex-1 min-w-0">
                                <FormInput
                                    label="Contract Address"
                                    placeholder="Enter Solana address..."
                                    value={contractAddress}
                                    onChange={(e) => setContractAddress(e.target.value)}
                                    disabled={isAnalyzing}
                                    className="h-12" // Explicit height to ensure matching
                                />
                            </div>
                            <div className="flex gap-2 shrink-0">
                                <PrimaryButton
                                    onClick={handleAnalyze}
                                    disabled={isAnalyzing || !contractAddress.trim()}
                                    className="px-4 sm:px-6 h-12 flex items-center justify-center"
                                >
                                    {isAnalyzing ? (
                                        <span className="flex items-center gap-2">
                                            <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                                            <span className="hidden sm:inline">Analyzing</span>
                                        </span>
                                    ) : (
                                        <span>Analyze</span>
                                    )}
                                </PrimaryButton>
                                {(contractAddress || analysisData) && !isAnalyzing && (
                                    <SecondaryButton onClick={handleClear} className="px-3 sm:px-5 h-12 flex items-center justify-center">
                                        Clear
                                    </SecondaryButton>
                                )}
                            </div>
                        </div>

                        {/* Quick Select */}
                        <div className="flex flex-wrap items-center gap-2">
                            <span className="text-[#8b949e] text-xs">Quick select:</span>
                            {sampleContracts.map((contract) => (
                                <button
                                    key={contract.value}
                                    onClick={() => setContractAddress(contract.value)}
                                    disabled={isAnalyzing}
                                    className="px-2 py-1 text-[10px] sm:text-xs rounded bg-[#21262d] border border-[#30363d] text-[#8b949e] hover:bg-[#30363d] hover:text-white transition-all disabled:opacity-50"
                                >
                                    {contract.label}
                                </button>
                            ))}
                        </div>
                    </div>
                </GlassContainerCard>

                {/* Analysis Content */}
                {(isAnalyzing || analysisData) && (
                    <div className="space-y-6">
                        {/* Risk Score Header - Only show after analysis */}
                        {analysisData?.riskScore && (
                            <GlassContainerCard className="p-6">
                                <div className="flex flex-wrap items-center justify-between gap-6">
                                    <div className="flex items-center gap-6">
                                        {/* Profile Image/Badge - Different display for DEX vs Token */}
                                        <div className={`w-16 h-16 rounded-lg flex items-center justify-center text-3xl font-bold border overflow-hidden ${analysisData.riskScore.grade === 'A' ? 'bg-green-500/10 text-green-400 border-green-500/30' :
                                            analysisData.riskScore.grade === 'B' ? 'bg-cyan-500/10 text-cyan-400 border-cyan-500/30' :
                                                analysisData.riskScore.grade === 'C' ? 'bg-yellow-500/10 text-yellow-400 border-yellow-500/30' :
                                                    analysisData.riskScore.grade === 'D' ? 'bg-orange-500/10 text-orange-400 border-orange-500/30' :
                                                        'bg-red-500/10 text-red-400 border-red-500/30'
                                            }`}>
                                            {/* For DEX mode, show program icon; for token mode, show token image */}
                                            {detectionMode === 'dex' ? (
                                                <svg className="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" strokeWidth="2" fill="none" />
                                                </svg>
                                            ) : analysisData.profileSummary?.imageUrl && !imageError ? (
                                                <img
                                                    src={analysisData.profileSummary.imageUrl}
                                                    alt={analysisData.profileSummary?.tokenName || 'Token'}
                                                    className="w-full h-full object-cover"
                                                    onError={() => setImageError(true)}
                                                />
                                            ) : (
                                                (analysisData.profileSummary?.tokenName?.[0] ||
                                                    analysisData.profileSummary?.tokenSymbol?.[0] ||
                                                    analysisData.type?.[0] || '?').toUpperCase()
                                            )}
                                        </div>

                                        <div>
                                            <h2 className="text-lg font-semibold text-white">
                                                {detectionMode === 'dex'
                                                    ? 'DEX/Program Analysis'
                                                    : (analysisData.profileSummary?.tokenName ||
                                                        (analysisData.type === 'program' ? 'Solana Program' :
                                                            analysisData.address.slice(0, 12) + '...'))}
                                            </h2>
                                            <p className="text-[#8b949e] flex items-center gap-2 mt-1">
                                                <span className={`px-2 py-0.5 rounded text-xs ${detectionMode === 'dex' ? 'bg-cyan-500/20 text-cyan-400' :
                                                    analysisData.type === 'token' ? 'bg-purple-500/20 text-purple-400' :
                                                        analysisData.type === 'program' ? 'bg-blue-500/20 text-blue-400' :
                                                            'bg-[#21262d] text-[#8b949e]'
                                                    }`}>
                                                    {detectionMode === 'dex' ? 'DEX' : analysisData.type.toUpperCase()}
                                                </span>
                                                <span className="font-mono text-sm">{analysisData.address}</span>
                                            </p>
                                        </div>
                                    </div>

                                    <div className="flex items-center gap-4">
                                        <div className="text-right">
                                            <p className="text-2xl font-bold text-white">{analysisData.riskScore.score}/100</p>
                                            <p className="text-xs text-[#8b949e]">Risk Score</p>
                                        </div>
                                        <SecondaryButton onClick={handleExport}>
                                            Export
                                        </SecondaryButton>
                                    </div>
                                </div>
                            </GlassContainerCard>
                        )}

                        {/* Tab Navigation */}
                        <div className="flex gap-1 bg-[#0d1117] p-1 rounded-lg border border-[#30363d] w-fit">
                            {tabs.map((tab) => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id as typeof activeTab)}
                                    className={`px-4 py-2 rounded text-sm font-medium transition-all ${activeTab === tab.id
                                        ? 'bg-[#21262d] text-white'
                                        : 'text-[#8b949e] hover:text-white'
                                        }`}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </div>

                        {/* Tab Content */}
                        <div>
                            {activeTab === 'overview' && analysisData && (
                                <>
                                    <AIAnalysisCard data={analysisData} />

                                    {/* DEX Mode: Show DEX-specific cards */}
                                    {detectionMode === 'dex' ? (
                                        <>
                                            {/* Row 1: Risk, Parameters, Trading */}
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                                                <RiskScoreCard data={analysisData} />
                                                <ParamsOverviewCard data={analysisData} />
                                                <TradingDataCard data={analysisData} />
                                            </div>

                                            {/* Row 2: Security and additional DEX data */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                                <SecurityDataCard data={analysisData} />
                                                <MiscCard data={analysisData} />
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            {/* Token Mode: Show token-specific cards */}
                                            {/* Row 1: Market, Profile, Risk Score */}
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                                                <MarketOverviewCard data={analysisData} />
                                                <ProfileSummaryCard data={analysisData} />
                                                <div className="space-y-4">
                                                    <MiscCard data={analysisData} />
                                                    <RiskScoreCard data={analysisData} />
                                                </div>
                                            </div>

                                            {/* Row 2: Security, Trading/Slippage, Params */}
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                                <SecurityDataCard data={analysisData} />
                                                <SlippageDataCard data={analysisData} />
                                                <ParamsOverviewCard data={analysisData} />
                                            </div>

                                            {/* Row 3: Trading Data (DEX, Slippage from old card) */}
                                            <div className="mt-4">
                                                <TradingDataCard data={analysisData} />
                                            </div>
                                        </>
                                    )}
                                </>
                            )}

                            {activeTab === 'overview' && !analysisData && isAnalyzing && (
                                <div className="text-center py-12 text-[#8b949e]">
                                    Analysis in progress...
                                </div>
                            )}



                            {activeTab === 'risks' && analysisData && (
                                <GlassContainerCard className="p-6">
                                    <h3 className="text-white font-medium mb-4">Risk Indicators</h3>
                                    <RiskIndicatorsList indicators={analysisData.riskIndicators} />
                                </GlassContainerCard>
                            )}

                            {activeTab === 'holders' && analysisData?.type === 'token' && (
                                <GlassContainerCard className="p-6">
                                    <h3 className="text-white font-medium mb-4">Top Token Holders</h3>
                                    <TopHoldersTable
                                        holders={analysisData.topHolders}
                                        decimals={analysisData.marketOverview.decimals}
                                    />
                                </GlassContainerCard>
                            )}

                            {activeTab === 'holders' && analysisData?.type !== 'token' && (
                                <GlassContainerCard className="p-6">
                                    <div className="text-center py-8 text-[#8b949e]">
                                        Holder data is only available for tokens
                                    </div>
                                </GlassContainerCard>
                            )}
                        </div>
                    </div>
                )}

                {/* Empty State */}
                {!isAnalyzing && !analysisData && (
                    <GlassContainerCard className="p-12">
                        <EmptyState
                            icon={<ShieldEmptyIcon />}
                            title="Ready to Analyze"
                            description="Enter a Solana contract address to begin real-time security analysis with on-chain data visualization."
                        />
                    </GlassContainerCard>
                )}
            </div>

            {/* Timeline Overlay */}
            <TimelineOverlay
                isVisible={showTimeline}
                steps={steps}
                totalDuration={totalDuration}
                isAnalyzing={isAnalyzing}
                onClose={() => setShowTimeline(false)}
                paramsChecked={paramsChecked}
                paramsTriggered={paramsTriggered}
                detectionMode={detectionMode}
            />
        </DashboardLayout>
    );
}
