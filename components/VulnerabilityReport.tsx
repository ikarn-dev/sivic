'use client';

import { GlassContainerCard } from '@/components/Card';
import { SeverityBreakdownChart } from '@/components/charts';
import { SecondaryButton } from '@/components/FormElements';

// Import types from API route
interface Vulnerability {
    id: string;
    severity: 'critical' | 'high' | 'medium' | 'low';
    title: string;
    description: string;
    recommendation: string;
    codeLocation?: string;
    cweId?: string;
}

interface AuditReport {
    contractAddress?: string;
    overallScore: number;
    riskLevel: 'safe' | 'low' | 'medium' | 'high' | 'critical';
    vulnerabilities: Vulnerability[];
    summary: string;
    gasOptimizations?: string[];
    bestPractices?: string[];
    analyzedAt: string;
    analysisType: 'address' | 'source';
}

interface VulnerabilityReportProps {
    report: AuditReport;
    onExport?: (format: 'json' | 'pdf') => void;
    className?: string;
}

/**
 * Vulnerability Report Component
 * Displays comprehensive audit results with severity breakdown
 */
export function VulnerabilityReport({
    report,
    onExport,
    className = '',
}: VulnerabilityReportProps) {
    // Count vulnerabilities by severity
    const severityCounts = {
        critical: report.vulnerabilities.filter(v => v.severity === 'critical').length,
        high: report.vulnerabilities.filter(v => v.severity === 'high').length,
        medium: report.vulnerabilities.filter(v => v.severity === 'medium').length,
        low: report.vulnerabilities.filter(v => v.severity === 'low').length,
    };

    const getScoreColor = () => {
        if (report.overallScore >= 90) return 'text-green-400';
        if (report.overallScore >= 70) return 'text-blue-400';
        if (report.overallScore >= 50) return 'text-yellow-400';
        if (report.overallScore >= 25) return 'text-orange-400';
        return 'text-red-400';
    };

    const getRiskBadgeColor = (risk: string) => {
        switch (risk) {
            case 'safe': return 'bg-green-500/20 text-green-400 border-green-500/30';
            case 'low': return 'bg-blue-500/20 text-blue-400 border-blue-500/30';
            case 'medium': return 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30';
            case 'high': return 'bg-orange-500/20 text-orange-400 border-orange-500/30';
            case 'critical': return 'bg-red-500/20 text-red-400 border-red-500/30';
            default: return 'bg-gray-500/20 text-gray-400 border-gray-500/30';
        }
    };

    const getSeverityColor = (severity: string) => {
        switch (severity) {
            case 'critical': return 'text-red-400 bg-red-500/10 border-red-500/30';
            case 'high': return 'text-orange-400 bg-orange-500/10 border-orange-500/30';
            case 'medium': return 'text-yellow-400 bg-yellow-500/10 border-yellow-500/30';
            case 'low': return 'text-green-400 bg-green-500/10 border-green-500/30';
            default: return 'text-gray-400 bg-gray-500/10 border-gray-500/30';
        }
    };

    const getSeverityIcon = (severity: string) => {
        switch (severity) {
            case 'critical': return 'ðŸ”´';
            case 'high': return 'ðŸŸ ';
            case 'medium': return 'ðŸŸ¡';
            case 'low': return 'ðŸŸ¢';
            default: return 'âšª';
        }
    };

    return (
        <div className={`space-y-4 ${className}`}>
            {/* Score Overview Card */}
            <GlassContainerCard>
                <div className="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
                    {/* Score Display */}
                    <div className="flex items-center gap-6">
                        <div className="text-center">
                            <p className="text-xs text-[rgba(255,255,255,0.4)] mb-1">Security Score</p>
                            <div className="flex items-baseline gap-1">
                                <span className={`text-5xl font-bold ${getScoreColor()}`}>
                                    {report.overallScore}
                                </span>
                                <span className="text-lg text-[rgba(255,255,255,0.4)]">/100</span>
                            </div>
                        </div>
                        <div className="h-16 w-px bg-[rgba(255,255,255,0.1)]" />
                        <div>
                            <span className={`px-3 py-1.5 text-sm font-medium rounded-full border ${getRiskBadgeColor(report.riskLevel)}`}>
                                {report.riskLevel.toUpperCase()} RISK
                            </span>
                            <p className="text-xs text-[rgba(255,255,255,0.4)] mt-2">
                                Analyzed: {new Date(report.analyzedAt).toLocaleString()}
                            </p>
                        </div>
                    </div>

                    {/* Export Buttons */}
                    {onExport && (
                        <div className="flex gap-2">
                            <SecondaryButton onClick={() => onExport('json')}>
                                Export JSON
                            </SecondaryButton>
                            <SecondaryButton onClick={() => onExport('pdf')}>
                                Export PDF
                            </SecondaryButton>
                        </div>
                    )}
                </div>

                {/* Summary */}
                <div className="mt-4 pt-4 border-t border-[rgba(255,255,255,0.06)]">
                    <p className="text-sm text-[rgba(255,255,255,0.7)]">{report.summary}</p>
                </div>
            </GlassContainerCard>

            {/* Severity Breakdown */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                {/* Chart */}
                <GlassContainerCard title="Issue Breakdown">
                    {report.vulnerabilities.length > 0 ? (
                        <SeverityBreakdownChart
                            critical={severityCounts.critical}
                            high={severityCounts.high}
                            medium={severityCounts.medium}
                            low={severityCounts.low}
                            height={180}
                        />
                    ) : (
                        <div className="flex items-center justify-center h-[180px] text-green-400">
                            <div className="text-center">
                                <span className="text-4xl">âœ“</span>
                                <p className="text-sm mt-2">No vulnerabilities detected</p>
                            </div>
                        </div>
                    )}
                </GlassContainerCard>

                {/* Quick Stats */}
                <GlassContainerCard title="Quick Stats">
                    <div className="grid grid-cols-2 gap-3">
                        <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/20">
                            <p className="text-xs text-red-300">Critical</p>
                            <p className="text-2xl font-bold text-red-400">{severityCounts.critical}</p>
                        </div>
                        <div className="p-3 rounded-lg bg-orange-500/10 border border-orange-500/20">
                            <p className="text-xs text-orange-300">High</p>
                            <p className="text-2xl font-bold text-orange-400">{severityCounts.high}</p>
                        </div>
                        <div className="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
                            <p className="text-xs text-yellow-300">Medium</p>
                            <p className="text-2xl font-bold text-yellow-400">{severityCounts.medium}</p>
                        </div>
                        <div className="p-3 rounded-lg bg-green-500/10 border border-green-500/20">
                            <p className="text-xs text-green-300">Low</p>
                            <p className="text-2xl font-bold text-green-400">{severityCounts.low}</p>
                        </div>
                    </div>
                </GlassContainerCard>
            </div>

            {/* Vulnerabilities List */}
            {report.vulnerabilities.length > 0 && (
                <GlassContainerCard title={`Vulnerabilities (${report.vulnerabilities.length})`}>
                    <div className="space-y-3">
                        {report.vulnerabilities.map((vuln, index) => (
                            <div
                                key={vuln.id || index}
                                className="p-4 rounded-lg bg-[rgba(255,255,255,0.02)] border border-[rgba(255,255,255,0.06)] hover:border-[rgba(255,255,255,0.12)] transition-colors"
                            >
                                {/* Header */}
                                <div className="flex items-start justify-between gap-3 mb-2">
                                    <div className="flex items-center gap-2">
                                        <span>{getSeverityIcon(vuln.severity)}</span>
                                        <span className={`px-2 py-0.5 text-xs font-medium rounded border ${getSeverityColor(vuln.severity)}`}>
                                            {vuln.severity.toUpperCase()}
                                        </span>
                                        <span className="text-sm font-medium text-white">{vuln.title}</span>
                                    </div>
                                    {vuln.cweId && (
                                        <span className="text-xs text-[rgba(255,255,255,0.4)] font-mono">
                                            {vuln.cweId}
                                        </span>
                                    )}
                                </div>

                                {/* Description */}
                                <p className="text-sm text-[rgba(255,255,255,0.6)] mb-3">
                                    {vuln.description}
                                </p>

                                {/* Code Location */}
                                {vuln.codeLocation && (
                                    <div className="mb-3">
                                        <span className="text-xs text-[rgba(255,255,255,0.4)]">Location: </span>
                                        <code className="text-xs text-[#f97316] bg-[rgba(249,115,22,0.1)] px-1.5 py-0.5 rounded">
                                            {vuln.codeLocation}
                                        </code>
                                    </div>
                                )}

                                {/* Recommendation */}
                                <div className="p-3 rounded bg-[rgba(255,255,255,0.03)] border-l-2 border-green-500">
                                    <p className="text-xs text-green-400 font-medium mb-1">Recommendation</p>
                                    <p className="text-sm text-[rgba(255,255,255,0.7)]">
                                        {vuln.recommendation}
                                    </p>
                                </div>
                            </div>
                        ))}
                    </div>
                </GlassContainerCard>
            )}

            {/* Best Practices & Gas Optimizations */}
            {(report.bestPractices?.length || report.gasOptimizations?.length) && (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {report.bestPractices && report.bestPractices.length > 0 && (
                        <GlassContainerCard title="Best Practices">
                            <ul className="space-y-2">
                                {report.bestPractices.map((practice, index) => (
                                    <li key={index} className="flex items-start gap-2 text-sm text-[rgba(255,255,255,0.7)]">
                                        <span className="text-blue-400 mt-0.5">ðŸ’¡</span>
                                        {practice}
                                    </li>
                                ))}
                            </ul>
                        </GlassContainerCard>
                    )}

                    {report.gasOptimizations && report.gasOptimizations.length > 0 && (
                        <GlassContainerCard title="Gas Optimizations">
                            <ul className="space-y-2">
                                {report.gasOptimizations.map((opt, index) => (
                                    <li key={index} className="flex items-start gap-2 text-sm text-[rgba(255,255,255,0.7)]">
                                        <span className="text-green-400 mt-0.5">âš¡</span>
                                        {opt}
                                    </li>
                                ))}
                            </ul>
                        </GlassContainerCard>
                    )}
                </div>
            )}
        </div>
    );
}

export default VulnerabilityReport;
